{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <div class="flex-header">
        <h2>Your Emotion Journey</h2>
        <div class="streak-badge">
            <span class="fire-icon">ðŸ”¥</span>
            <span class="count">{{ current_user.streak_count }} Days Streak</span>
        </div>
    </div>

    <div class="stats-grid">
        <div class="chart-card">
            <h4>Emotion Frequency</h4>
            <canvas id="emotionChart"></canvas>
        </div>
        <div class="chart-card">
            <h4>Mood Calendar</h4>
            <div id="calendar-grid" class="calendar-grid">
                <!-- Calendar Generated by JS -->
            </div>
        </div>
    </div>

    <div class="history-section">
        <h3>Recent Conversations</h3>
        <div class="message-history">
            {% for msg in recent_messages %}
            <div class="history-item {{ 'bot' if msg.is_bot else 'user' }}">
                <span class="timestamp">{{ msg.timestamp.strftime('%H:%M') }}</span>
                <p>{{ msg.content }}</p>
                {% if not msg.is_bot and msg.emotion %}
                <span class="emotion-tag">{{ msg.emotion }}</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    .flex-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .streak-badge {
        background: #fee2e2;
        color: #b91c1c;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 10px;
    }

    .cal-day {
        aspect-ratio: 1;
        border-radius: 44px;
        border: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        position: relative;
    }

    .cal-day.has-emotion {
        cursor: pointer;
    }

    .cal-day.happy,
    .cal-day.positive {
        background: #dcfce7;
        border-color: #86efac;
    }

    .cal-day.sad,
    .cal-day.fatigue {
        background: #f3f4f6;
        border-color: #d1d5db;
    }

    .cal-day.angry,
    .cal-day.frustration {
        background: #fee2e2;
        border-color: #fca5a5;
    }

    .cal-day.anxious,
    .cal-day.anxiety {
        background: #ffedd5;
        border-color: #fdba74;
    }
</style>

<script>
    fetch('/api/analytics')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('emotionChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#F87171', '#60A5FA', '#FBBF24', '#34D399', '#A78BFA'
                        ]
                    }]
                },
                options: { responsive: true }
            });
        });

    fetch('/api/calendar')
        .then(response => response.json())
        .then(data => {
            const grid = document.getElementById('calendar-grid');
            // Simple mockup: Last 14 days
            for (let i = 13; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const dayDiv = document.createElement('div');
                dayDiv.className = 'cal-day';
                dayDiv.textContent = d.getDate();

                if (data[dateStr]) {
                    dayDiv.classList.add('has-emotion');
                    dayDiv.classList.add(data[dateStr].toLowerCase());
                    dayDiv.title = data[dateStr];
                }
                grid.appendChild(dayDiv);
            }
        });
</script>
{% endblock %}